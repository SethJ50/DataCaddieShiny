---
title: "CourseClustering"
output: pdf_document
date: "2025-12-21"
---
### Load Libraries
```{r}
library(dplyr)
library(ggplot2)
library(factoextra)
```

### Load Data from DB
```{r}
source("uploadUtils/db_connection.R")
course_diff_conn <- get_mongo_collection("coursedifficulties")
data <- course_diff_conn$find('{}') %>% 
  filter(year == "all")
```

### Cluster Data
```{r}
cluster_cols <- c('par', 'yardage', 'difficulty',     'adj_driving_distance', 'adj_driving_accuracy', 'fw_width',
'fw_diff', 'adj_penalties')
non_cluster <- c('course', 'year')

#cluster_data <- data %>% select(cluster_cols)
cluster_data <- data %>% select(-all_of(non_cluster)) %>% 
  mutate(across(everything(), ~ tidyr::replace_na(.x, 0)))

course_info <- data %>% 
  select(course, year)
```

### Elbow Method
```{r}
scaled_data <- scale(cluster_data)

set.seed(123)

fviz_nbclust(
  scaled_data,
  kmeans,
  method = "wss"
) +
  geom_vline(xintercept = 5, linetype = 2) +
  labs(title = "Elbow Method for K Selection")
```

### Run K-Means
```{r}
set.seed(123)

k <- 6
kmeans_model <- kmeans(
  scaled_data,
  centers = k,
  nstart = 25
)

cluster_data$cluster <- factor(kmeans_model$cluster)
```

### PCA Visualization
```{r}
pca <- prcomp(scaled_data, center = TRUE, scale. = TRUE)

pca_df <- data.frame(
  PC1 = pca$x[, 1],
  PC2 = pca$x[, 2],
  cluster = cluster_data$cluster
)

ggplot(pca_df, aes(PC1, PC2, color = cluster)) +
  geom_point(size = 2, alpha = 0.8) +
  labs(
    title = "K-means Clusters (PCA Projection)",
    x = "PC1",
    y = "PC2"
  ) +
  theme_minimal()
```

### Interpret Clusters
```{r}
cluster_summaries <- cluster_data %>%
  group_by(cluster) %>%
  summarise(across(where(is.numeric), mean, na.rm = TRUE), n = n())

View(cluster_summaries)

```

```{r}
recombine_data <- bind_cols(course_info, cluster_data)

names(recombine_data)

cluster_N <- recombine_data %>%
  filter(cluster == 5) %>%
  select(course, par, yardage, difficulty, adj_driving_distance, adj_driving_accuracy, fw_width, fw_diff, adj_penalties)

View(cluster_N)
```






# Driver Strategy

### Load Libraries
```{r}
library(dplyr)
library(ggplot2)
library(factoextra)
library(corrplot)
```

### Load Data from DB
```{r}
source("uploadUtils/db_connection.R")
course_diff_conn <- get_mongo_collection("coursedifficulties")
course_data <- course_diff_conn$find('{}') %>% 
  filter(year == "all")
```

**Driving Stats:**
- yardage_4_5: Average length of par 4's and 5's
- adj_driving_distance: Average driving distance ('hit driver rate')
- adj_sd_distance: Average standard deviation of driving distance (club choice variability)
- adj_driving_accuracy: Average driving accuracy
- ott_sg: SG: OTT ease
- fw_width: Average fairway width
- fw_diff: Missed fairway penalty - Average difference in hole score between fairway and non-fairway drives on par 4s and 5s
- rgh_diff: Rough penalty - Difference in average strokes to hole out from the rough versus the fairway.
- non_rgh_diff: Non-rough penalty - Difference in average strokes to hole out from non-rough locations (e.g. bunkers) versus the fairway.

### Correlation Analysis
```{r}
possible_cols <- c('yardage_4_5', 'adj_driving_distance', 'adj_sd_distance',
                  'adj_driving_accuracy', 'ott_sg', 'fw_width', 'fw_diff', 'rgh_diff',  'non_rgh_diff')

corr_data <- course_data %>% 
  select(all_of(possible_cols))

# Compute correlation matrix
corr_matrix <- cor(corr_data, use = "pairwise.complete.obs")

# Plot correlation matrix
corrplot(corr_matrix, method = "color", type = "upper", 
         tl.col = "black", tl.srt = 45, addCoef.col = "black", 
         number.cex = 0.7, col = colorRampPalette(c("blue", "white", "red"))(200))
```



### Cluster Data
```{r}
cluster_cols <- c('yardage_4_5', 'adj_driving_distance', 'adj_sd_distance',
                  'adj_driving_accuracy', 'ott_sg', 'fw_width', 'fw_diff')
non_cluster <- c('course', 'year')
course_info_cols <- c('course', 'year')

cluster_data <- course_data %>% select(cluster_cols) %>% 
  mutate(across(everything(), ~ tidyr::replace_na(.x, 0)))

course_info <- course_data %>% 
  select(course)
```

### Elbow Method
```{r}
scaled_data <- scale(cluster_data)

set.seed(123)

fviz_nbclust(
  scaled_data,
  kmeans,
  method = "wss"
) +
  geom_vline(xintercept = 6, linetype = 2) +
  labs(title = "Elbow Method for K Selection")
```

### Run K-Means
```{r}
set.seed(123)

k <- 5
kmeans_model <- kmeans(
  scaled_data,
  centers = k,
  nstart = 25
)

cluster_data$cluster <- factor(kmeans_model$cluster)
```

### PCA Visualization
```{r}
pca <- prcomp(scaled_data, center = TRUE, scale. = TRUE)

pca_df <- data.frame(
  PC1 = pca$x[, 1],
  PC2 = pca$x[, 2],
  cluster = cluster_data$cluster
)

ggplot(pca_df, aes(PC1, PC2, color = cluster)) +
  geom_point(size = 2, alpha = 0.8) +
  labs(
    title = "K-means Clusters (PCA Projection)",
    x = "PC1",
    y = "PC2"
  ) +
  theme_minimal()
```

### Interpret Clusters
```{r}
cluster_summaries <- cluster_data %>%
  group_by(cluster) %>%
  summarise(across(where(is.numeric), mean, na.rm = TRUE), n = n())

View(cluster_summaries)
```

```{r}
recombine_data <- bind_cols(course_info, cluster_data)

cluster_N <- recombine_data %>%
  filter(cluster == 2) %>%
  select(c(course, cluster_cols))

saveRDS(recombine_data, "course_ott_clusters.rds")

View(recombine_data)
```

